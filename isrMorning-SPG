import requests
import json
import openpyxl as xl
from salesforce_reporting import Connection, ReportParser
import datetime as dt
import smtplib
from credentials import login #<--- separate file has credentials in dictionary 'login'

# SF connection
sf = Connection(username=login['sfEmail'], password=login['password'], security_token=login['token'])

#SPG Closers
names = ['SalesRep FullName','SalesRep FullName2', 'SalesRep FullName3'......'SalesRep FullName30']

#variables for dates used in HDAP request and files naming
todayMonth = dt.datetime.now().strftime('%m')
todayDay = dt.datetime.now().strftime('%d')
yesterday = dt.datetime.now() - dt.timedelta(days=1)
yesterdayMonth = yesterday.strftime('%m')
yesterdayDay = yesterday.strftime('%d')
yesterdayYear = yesterday.strftime('%Y')
yesterdayMonthDay = yesterdayMonth + '-' + yesterdayDay

# JSON call data from HDAP
url = 'https://my.vonagebusiness.com/appserver/rest/usersummarymetricsresource?chartType=summary&startDateInGMT=2017-' + yesterdayMonth + '-' + yesterdayDay + 'T00:00:00Z&endDateInGMT=2017-'+todayMonth+'-'+todayDay+'T00:00:00Z&lineChartType=Total%20Calls&accountId=25016'
jsonData = requests.get(url, auth=(login['username'], login['password'],)).json()

callDataList = []
def pullCallData(person):
	for i in range(len(jsonData)):
		salesRep = jsonData[i]['category']['categoryName']
		calls = int(jsonData[i]['metrics'][4]['value'])
		talkTime = jsonData[i]['metrics'][1]['value']

		if salesRep == person:
			individualCallData = [salesRep, calls, dt.time(*map(int, talkTime.split(':')))]
			callDataList.append(individualCallData)

for name in names:
	pullCallData(name)

mtdSales = '00O140000094LBo'
mtdSalesSf = sf.get_report(mtdSales, details=True)
mtd = ReportParser(mtdSalesSf).records()
for value in mtd:
	value[13] = value[13].replace('$','').replace('(','').replace(')','').replace('-','0')
	value[13] = float(value[13])

yesterdayOpps = '00O140000094H9U'
oppsSf = sf.get_report(yesterdayOpps, details=True)
opps = ReportParser(oppsSf).records()

yesterdaySales = '00O14000008zXTn'
salesSf = sf.get_report(yesterdaySales, details=True)
sales = ReportParser(salesSf).records()
for value in sales:
	value[13] = value[13].replace('$','').replace('(','').replace(')','').replace('-','0')
	value[13] = float(value[13])

# Open Excel template and insert the lists of data for yesterday
xlOpen = xl.load_workbook('/Users/rubinj30/Google Drive/Daily Reports-SPG/SPG Closer - Template.xlsx')

# Get HDAP sheet and insert Reps, Calls, and Talk Time

hdapSheet = xlOpen.get_sheet_by_name('HDAP')
for data in callDataList:
	hdapSheet.append(data)

mtdSheet = xlOpen.get_sheet_by_name('MTD')
for data in mtd:
    mtdSheet.append(data)

#Get opps sheet and insert new Opportunities
oppsSheet = xlOpen.get_sheet_by_name('opps')
for data in opps:
    oppsSheet.append(data)
    
#Get organic sheet and insert organic deals
salesSheet = xlOpen.get_sheet_by_name('sales')
for data in sales:
    salesSheet.append(data)

xlOpen.save('/Users/rubinj30/Google Drive/Daily Reports-SPG/'+yesterdayMonth+'-'+yesterdayYear+'/'+yesterdayMonthDay +' SPG-ISR.xlsx')

smtpObj = smtplib.SMTP('smtp.gmail.com', 587)
smtpObj.ehlo()
smtpObj.starttls()

smtpObj.login('my@email.com', login['gmailPassword'])
hyperlinkDrive = 'https://drive.google.com/drive/folders/0ByBUMjHVt7glVThTZmtxRmRhYWc'
recipients = ['supervisor@email','supervisor@email','supervisor@email','supervisor@email']
smtpObj.sendmail('jonathan.rubin@vonage.com',recipients,
	"Subject: SPG Closer Report "+yesterdayMonthDay+"\n\nYou can find the completed SPG Closer Report in this Google Drive folder:\n\n"+hyperlinkDrive+"\n\nYou can open it with Google Sheets or Excel.\n\n Thanks,\nJonathan")

smtpObj.quit()
